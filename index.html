<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>Face Unlock</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
  body { font-family: sans-serif; background: #222; color: #fff; text-align:center; }
  video { width: 320px; border: 2px solid #fff; margin-top: 20px; }
  #status { margin-top: 10px; font-size: 18px; }
  #registeredModal {
      position: fixed; right:20px; bottom:20px;
      background:#0af; color:#fff; padding:10px 15px;
      border-radius:8px; display:none;
  }
</style>
</head>
<body>

<h1>Face Unlock</h1>

<button id="loadBtn">モデル読み込み</button>
<button id="registerBtn">顔登録</button>
<button id="authBtn">認証開始</button>

<br>
<video id="video" autoplay muted></video>
<canvas id="canvas"></canvas>
<div id="status">待機中</div>

<div id="registeredModal">登録完了！</div>

<script>
const MODEL_URL = "https://hc0t48ah6n.github.io/face_unlock/weights/";
let registeredDescriptor = null;

document.getElementById("loadBtn").onclick = async () => {
    document.getElementById("status").innerText = "モデル読み込み中…";

    await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
    await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
    await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);

    document.getElementById("status").innerText = "モデル読み込み完了！";
};

document.getElementById("registerBtn").onclick = async () => {
    document.getElementById("status").innerText = "カメラ起動中…";

    const stream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById("video");
    video.srcObject = stream;

    await new Promise(resolve => video.onloadedmetadata = resolve);

    document.getElementById("status").innerText = "顔を登録しています…";

    const det = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320 }))
        .withFaceLandmarks()
        .withFaceDescriptor();

    if (!det) {
        document.getElementById("status").innerText = "顔が検出できませんでした";
        return;
    }

    registeredDescriptor = det.descriptor;

    document.getElementById("registeredModal").style.display = "block";
    setTimeout(() => {
        document.getElementById("registeredModal").style.display = "none";
    }, 2000);

    document.getElementById("status").innerText = "登録完了！";
};

document.getElementById("authBtn").onclick = () => {
    if (!registeredDescriptor) {
        document.getElementById("status").innerText = "先に顔を登録してください";
        return;
    }

    const video = document.getElementById("video");

    async function loop() {
        const det = await faceapi
            .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions({ inputSize: 320 }))
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (det) {
            const dist = faceapi.euclideanDistance(registeredDescriptor, det.descriptor);
            if (dist < 0.45) {
                document.body.style.background = "#0044ff";
                document.getElementById("status").innerText = "認証成功！";
            } else {
                document.body.style.background = "#222";
                document.getElementById("status").innerText = "一致せず…";
            }
        }

        requestAnimationFrame(loop);
    }

    loop();
};
</script>

</body>
</html>
