<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Face Unlock (face-api.js)</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
body { background:#111; color:white; font-family:sans-serif; text-align:center; }
#video { width:320px; border:2px solid #333; margin-top:20px; }
#unlocked { font-size:40px; margin-top:20px; color:#0f0; display:none; }
</style>
</head>
<body>

<h1>Face Unlock<br><small>face-api.js version</small></h1>

<video id="video" autoplay muted></video>
<p id="status">Loading models...</p>

<button id="registerBtn">この顔を登録する</button>
<p>（登録すると本人認証が開始）</p>

<div id="unlocked">UNLOCKED!</div>

<script>
// ----------------------------
// モデル読み込み
// ----------------------------
Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights"),
    faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights"),
    faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights")
]).then(startVideo);

// ----------------------------
// カメラ起動
// ----------------------------
function startVideo() {
    navigator.mediaDevices.getUserMedia({ video: {} })
    .then(stream => {
        video.srcObject = stream;
        document.getElementById("status").innerText = "Ready!";
    });
}

let registeredDescriptor = null; // ← 登録した顔データ

// ----------------------------
// 顔登録ボタン
// ----------------------------
document.getElementById("registerBtn").onclick = async () => {
    const detection = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

    if (!detection) {
        alert("顔が見つかりません！");
        return;
    }

    registeredDescriptor = detection.descriptor;

    alert("顔を登録しました！ 認証開始します。");
    runRecognition();
};

// ----------------------------
// 本人認証ループ
// ----------------------------
async function runRecognition() {
    const THRESHOLD = 0.45; // ← これより小さいと本人（0.3〜0.6が適正）

    setInterval(async () => {
        if (!registeredDescriptor) return;

        const detection = await faceapi
            .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (!detection) return;

        let distance = faceapi.euclideanDistance(
            registeredDescriptor,
            detection.descriptor
        );

        console.log("distance:", distance);

        if (distance < THRESHOLD) {
            document.getElementById("unlocked").style.display = "block";
        }

    }, 200);
}
</script>

</body>
</html>
