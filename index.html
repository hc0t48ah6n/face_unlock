<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Face Unlock (face-api.js)</title>
<script defer src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<style>
body { background:#111; color:white; font-family:sans-serif; text-align:center; }
#video { width:320px; border:2px solid #333; margin-top:20px; }
#unlocked { font-size:40px; margin-top:20px; color:#0f0; display:none; }
button { padding:10px 20px; font-size:16px; margin-top:20px; }
</style>
</head>
<body>

<h1>Face Unlock</h1>

<button id="startBtn">カメラを開始</button><br>
<video id="video" autoplay muted playsinline></video>

<p id="status"></p>

<button id="registerBtn" style="display:none;">この顔を登録する</button>

<div id="unlocked">UNLOCKED!</div>

<script>
let registeredDescriptor = null;

// ----------------------------
// モデル読み込み
// ----------------------------
async function loadModels() {
    document.getElementById("status").innerText = "モデル読み込み中...";

    await faceapi.nets.tinyFaceDetector.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
    await faceapi.nets.faceRecognitionNet.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");
    await faceapi.nets.faceLandmark68Net.loadFromUri("https://cdn.jsdelivr.net/npm/face-api.js/weights");

    document.getElementById("status").innerText = "モデル読み込み完了";
}
loadModels();

// ----------------------------
// カメラ開始（ユーザー操作が必要）
// ----------------------------
document.getElementById("startBtn").onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById("video").srcObject = stream;

        document.getElementById("status").innerText = "カメラ起動OK ✔";
        document.getElementById("registerBtn").style.display = "inline-block";
    } catch (err) {
        document.getElementById("status").innerText = "カメラエラー: " + err.name;
        console.error(err);
    }
};

// ----------------------------
// 顔登録
// ----------------------------
document.getElementById("registerBtn").onclick = async () => {
    const video = document.getElementById("video");

    const detection = await faceapi
        .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

    if (!detection) {
        alert("顔が検出されません。もう一度。");
        return;
    }

    registeredDescriptor = detection.descriptor;

    alert("顔を登録しました！認証を開始します。");
    runRecognition();
};

// ----------------------------
// 認証ループ
// ----------------------------
async function runRecognition() {
    const video = document.getElementById("video");
    const THRESHOLD = 0.45;

    setInterval(async () => {
        if (!registeredDescriptor) return;

        const detection = await faceapi
            .detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();

        if (!detection) return;

        const distance = faceapi.euclideanDistance(
            registeredDescriptor,
            detection.descriptor
        );

        console.log("distance:", distance);

        if (distance < THRESHOLD) {
            document.getElementById("unlocked").style.display = "block";
        }

    }, 200);
}
</script>

</body>
</html>
