<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Face Unlock</title>
<style>
body { background:#111; color:white; font-family:sans-serif; text-align:center; }
#video { width:320px; border:2px solid #444; margin-top:20px; }
#canvasOutput { display:none; }
#msg {
    position:fixed; right:10px; bottom:10px; background:#0a0; padding:10px 20px;
    border-radius:10px; display:none; color:white;
}
#unlocked {
    font-size:40px; margin-top:20px; color:#0f0; display:none;
}
</style>
</head>

<body>
<h1>Face Unlock</h1>

<video id="video" autoplay playsinline></video>
<br>
<button id="captureBtn">撮影（10枚中の1枚）</button>
<p id="count">学習用撮影：0 / 10</p>

<div id="unlocked">Unlocked!</div>

<canvas id="canvasOutput"></canvas>
<div id="msg">保存完了！</div>

<script src="opencv.js" onload="onOpenCvReady()"></script>

<script>
let video = document.getElementById("video");
let cap;
let classifier;
let recognizer;
let trainingImages = [];
let trainingLabels = [];
let captureCount = 0;
let TRAIN_MAX = 10;   // ← あなたの設定
let THRESHOLD = 80;   // ← あなたの設定（これより小さいと本人）
let isTrained = false;

// ----------------------------
// OpenCV が読み込まれた時
// ----------------------------
function onOpenCvReady() {
    console.log("OpenCV.js Loaded!");
    startCamera();
    loadCascade();
}

// ----------------------------
// カメラ開始
// ----------------------------
function startCamera() {
    navigator.mediaDevices.getUserMedia({ video:true }).then(stream => {
        video.srcObject = stream;
        video.onloadedmetadata = () => {
            video.play();
            cap = new cv.VideoCapture(video);
            requestAnimationFrame(drawLoop);
        };
    });
}

// ----------------------------
// ここで GitHub の XML を読み込む！
// ----------------------------
async function loadCascade() {
    const url = "https://raw.githubusercontent.com/hc0t48ah6n/face_unlock/main/haarcascade_frontalface_default.xml";
    
    let res = await fetch(url);
    let xmlText = await res.text();

    cv.FS_createDataFile("/", "face.xml", xmlText, true, false);

    classifier = new cv.CascadeClassifier();
    let ok = classifier.load("face.xml");

    if(!ok){
        console.error("Cascade load failed!!!!");
    } else {
        console.log("Cascade loaded OK");
    }
}

// ----------------------------
// 顔検出・認証ループ
// ----------------------------
function drawLoop() {

    if (!classifier) {
        requestAnimationFrame(drawLoop);
        return;
    }

    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    let gray = new cv.Mat();
    cap.read(src);
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    let faces = new cv.RectVector();
    classifier.detectMultiScale(gray, faces, 1.1, 3, 0);

    if (faces.size() > 0) {
        let face = faces.get(0);

        if(isTrained){
            // 認証！
            let faceMat = gray.roi(face);
            let result = recognizer.predict(faceMat);
            faceMat.delete();

            console.log("confidence:", result.confidence);

            if(result.confidence < THRESHOLD){
                document.getElementById("unlocked").style.display="block";
            }
        }
    }

    src.delete(); gray.delete(); faces.delete();
    requestAnimationFrame(drawLoop);
}

// ----------------------------
// 撮影ボタン
// ----------------------------
document.getElementById("captureBtn").onclick = () => {
    if (captureCount >= TRAIN_MAX) return;

    let src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
    let gray = new cv.Mat();
    cap.read(src);
    cv.cvtColor(src, gray, cv.COLOR_RGBA2GRAY);

    let faces = new cv.RectVector();
    classifier.detectMultiScale(gray, faces, 1.1, 3, 0);

    if (faces.size() > 0) {
        let face = faces.get(0);
        let faceMat = gray.roi(face);

        trainingImages.push(faceMat.clone());
        trainingLabels.push(0);

        faceMat.delete();
        captureCount++;

        document.getElementById("count").innerText =
            `学習用撮影：${captureCount} / ${TRAIN_MAX}`;

        showMsg();
    }

    src.delete(); gray.delete(); faces.delete();

    if(captureCount === TRAIN_MAX){
        trainModel();
    }
};

// ----------------------------
// LBPH で本人モデルを作成
// ----------------------------
function trainModel() {
    recognizer = new cv.LBPHFaceRecognizer();
    recognizer.train(trainingImages, trainingLabels);
    isTrained = true;
    console.log("Training completed!");
}

// ----------------------------
// 右下メッセージ表示
// ----------------------------
function showMsg(){
    let m = document.getElementById("msg");
    m.style.display = "block";
    setTimeout(()=>{ m.style.display="none"; }, 1200);
}
</script>

</body>
</html>
